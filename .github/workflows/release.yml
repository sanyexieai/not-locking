name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          
      - name: Build
        run: cargo build --release
        
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/release/not-locking.exe
            not-locking.exe.manifest
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update Version
        run: |
          # 获取当前版本号
          $version = (Get-Content Cargo.toml | Select-String '^version = "([^"]+)"').Matches[0].Groups[1].Value
          
          # 分割版本号
          $parts = $version -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]
          
          # 增加补丁版本号
          $newPatch = $patch + 1
          $newVersion = "$major.$minor.$newPatch"
          
          # 更新 Cargo.toml
          (Get-Content Cargo.toml) -replace '^version = ".*"', "version = `"$newVersion`"" | Set-Content Cargo.toml
          
          # 提交更改
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Cargo.toml
          git commit -m "Bump version to $newVersion"
          git push 